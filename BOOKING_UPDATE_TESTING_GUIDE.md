# ××“×¨×™×š ×œ×‘×“×™×§×ª ×¢×“×›×•×Ÿ ×”×–×× ×•×ª (Booking Updates Testing Guide)

## ×¡×™×›×•× ×”×©×™× ×•×™×™× ×©×‘×•×¦×¢×•

### 1. ×ª×™×§×•×Ÿ Token Persistence âœ…
**×‘×¢×™×”:** Tokens ×©×¨×•×¢× × ×• ×œ× × ×©××¨×• ×—×–×¨×” ×œ××¡×“ ×”× ×ª×•× ×™×, ××” ×©×’×¨× ×œ×›×œ ×‘×§×©×” ×œ×”×©×ª××© ×‘-token ×¤×’ ×ª×•×§×£.

**×¤×ª×¨×•×Ÿ:**
- ×”×•×¡×¤×ª ×©××™×¨×” ××•×˜×•××˜×™×ª ×©×œ tokens ×—×“×©×™× ×œ××¡×“ ×”× ×ª×•× ×™×
- ×”×¢×‘×¨×ª `userId` ×œ×¤×•× ×§×¦×™×™×ª `fetchWithTokenRefresh`
- ×¢×“×›×•×Ÿ ×˜×‘×œ×ª `users` ×¢× ×”-token ×”×—×“×© ××—×¨×™ refresh ××•×¦×œ×—

**×§×‘×¦×™× ×©×”×©×ª× ×•:**
- `src/lib/beds24/tokenManager.ts`
- `src/app/api/dashboard/bookings/route.ts`

### 2. × ×¨××•×œ ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ âœ…
**×‘×¢×™×”:** ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ × ×©×œ×—×• ×œ×œ× × ×¨××•×œ, ××” ×©×¢×œ×•×œ ×œ×’×¨×•× ×œ×‘×¢×™×•×ª ×¤×•×¨××˜.

**×¤×ª×¨×•×Ÿ:**
- ×©×™××•×© ×‘-`normalizePhoneNumber` ×œ×¤× ×™ ×©×œ×™×—×” ×œ-Beds24
- ×”××¨×” ××•×˜×•××˜×™×ª ×œ×¤×•×¨××˜ ×‘×™× ×œ××•××™ (+972...)

### 3. ×©×™×¤×•×¨ ×•×œ×™×“×¦×™×” ×•×œ×•×’×™× âœ…
**×©×™×¤×•×¨×™×:**
- ×•×œ×™×“×¦×™×” ×©×œ `bookingId` ×œ×¤× ×™ ×©×œ×™×—×”
- ×•×œ×™×“×¦×™×” ×©×œ ××—×™×¨ (×—×™×™×‘ ×œ×”×™×•×ª ××¡×¤×¨ ×—×™×•×‘×™)
- ×œ×•×’×™× ××¤×•×¨×˜×™× ×¢× ×›×œ ×”××™×“×¢ ×”×¨×œ×•×•× ×˜×™
- ×”×•×“×¢×•×ª ×©×’×™××” ×‘×¨×•×¨×•×ª ×™×•×ª×¨ ×œ×¤×™ ×¡×•×’ ×”×©×’×™××”

### 4. ×ª×™×§×•×Ÿ ×¤×•×¨××˜ ××—×™×¨ âœ…
**×‘×¢×™×”:** ×”××—×™×¨ × ×©×œ×— ×›×©×“×” `price` ×¤×©×•×˜ ×‘××§×•× invoice format.

**×¤×ª×¨×•×Ÿ:**
- ×©×™××•×© ×‘-invoice format ×”× ×›×•×Ÿ ×©×œ Beds24 V2 API
- ×”××¨×” ××•×˜×•××˜×™×ª ×©×œ ××—×™×¨ ×œ-invoice array

---

## ××™×š ×œ×‘×“×•×§ ××ª ×”×¢×“×›×•× ×™×

### ×©×œ×‘ 1: ×‘×“×™×§×” ×¨××©×•× ×™×ª - ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª

1. ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª ×¢× ××©×ª××© ×××™×ª×™ (×œ× demo)
2. ×•×“× ×©×™×© ×œ×š ×”×¨×©××•×ª ×¢×“×›×•×Ÿ ×‘×”×–×× ×•×ª
3. ×¤×ª×— ××ª Developer Console ×‘×“×¤×“×¤×Ÿ (F12)

### ×©×œ×‘ 2: ×‘×“×™×§×ª ×¢×“×›×•×Ÿ ×˜×œ×¤×•×Ÿ

#### ×ª×¨×—×™×© 1: ×¢×“×›×•×Ÿ ×˜×œ×¤×•×Ÿ ×‘×¤×•×¨××˜ ×™×©×¨××œ×™
```
×˜×œ×¤×•×Ÿ ××§×•×¨×™: 0528676516
×¢×“×›×•×Ÿ ×œ: 050-123-4567
×ª×•×¦××” ×¦×¤×•×™×”: +972501234567 (×œ××—×¨ × ×¨××•×œ)
```

**×¦×¢×“×™×:**
1. ×‘×—×¨ ×”×–×× ×” ×§×™×™××ª
2. ×¢×¨×•×š ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×œ: `050-123-4567`
3. ×©××•×¨
4. ×‘×“×•×§ ×‘-Console:
   ```
   ğŸ“± Normalized mobile: 050-123-4567 -> +972501234567
   ```
5. ×‘×“×•×§ ×‘-Beds24 ×©×”×˜×œ×¤×•×Ÿ ×”×ª×¢×“×›×Ÿ

#### ×ª×¨×—×™×© 2: ×¢×“×›×•×Ÿ ×˜×œ×¤×•×Ÿ ×¢× ×¤×•×¨××˜ ×‘×™× ×œ××•××™
```
×¢×“×›×•×Ÿ ×œ: +972501234567
×ª×•×¦××” ×¦×¤×•×™×”: +972501234567 (×œ×œ× ×©×™× ×•×™)
```

### ×©×œ×‘ 3: ×‘×“×™×§×ª ×¢×“×›×•×Ÿ ××—×™×¨

#### ×ª×¨×—×™×© 1: ×¢×“×›×•×Ÿ ××—×™×¨ ×¨×’×™×œ
```
××—×™×¨ ××§×•×¨×™: 500
×¢×“×›×•×Ÿ ×œ: 750
```

**×¦×¢×“×™×:**
1. ×‘×—×¨ ×”×–×× ×” ×§×™×™××ª
2. ×¢×¨×•×š ××ª ×”××—×™×¨ ×œ: `750`
3. ×©××•×¨
4. ×‘×“×•×§ ×‘-Console:
   ```
   ğŸ’° Price update via invoice: 750
   ğŸ“¦ Update payload: {
     "id": "...",
     "invoice": [{
       "description": "Total Room Price",
       "amount": 750,
       "qty": 1,
       "type": "item"
     }]
   }
   ```
5. ×‘×“×•×§ ×‘-Beds24 ×©×”××—×™×¨ ×”×ª×¢×“×›×Ÿ

#### ×ª×¨×—×™×© 2: ×•×œ×™×“×¦×™×™×ª ××—×™×¨ ×œ× ×ª×§×™×Ÿ
```
×¢×“×›×•×Ÿ ×œ: -100 (××¡×¤×¨ ×©×œ×™×œ×™)
×ª×•×¦××” ×¦×¤×•×™×”: ×©×’×™××” 400 - Invalid price value
```

### ×©×œ×‘ 4: ×‘×“×™×§×ª ×¢×“×›×•×Ÿ ×˜×œ×¤×•×Ÿ + ××—×™×¨ ×‘×™×—×“

**×¦×¢×“×™×:**
1. ×‘×—×¨ ×”×–×× ×” ×§×™×™××ª
2. ×¢×¨×•×š ×’× ×˜×œ×¤×•×Ÿ ×•×’× ××—×™×¨:
   - ×˜×œ×¤×•×Ÿ: `052-999-8888`
   - ××—×™×¨: `650`
3. ×©××•×¨
4. ×‘×“×•×§ ×‘-Console:
   ```
   ğŸ“± Normalized mobile: 052-999-8888 -> +972529998888
   ğŸ’° Price update via invoice: 650
   âœ… Booking updated successfully: [booking-id]
   ```
5. ×‘×“×•×§ ×‘-Beds24 ×©×©× ×™ ×”×©×“×•×ª ×”×ª×¢×“×›× ×•

### ×©×œ×‘ 5: ×‘×“×™×§×ª Token Refresh

×–×” ×”×¦×¢×“ ×”×›×™ ×—×©×•×‘! ×”×‘×¢×™×” ×”××§×•×¨×™×ª ×”×™×ª×” ×©×”-tokens ×œ× × ×©××¨×•.

**×¦×¢×“×™×:**
1. ××¦× ××ª ×”-token ×”× ×•×›×—×™ ×‘××¡×“ ×”× ×ª×•× ×™×:
   ```sql
   SELECT beds24_token, beds24_refresh_token 
   FROM users 
   WHERE email = 'your-email@example.com';
   ```
2. ×¢×©×” ×›××” ×¢×“×›×•× ×™× ×œ×”×–×× ×•×ª (3-4 ×¢×“×›×•× ×™×)
3. ×× ×™×© ×©×’×™××ª 401/502, ×”××¢×¨×›×ª ×¦×¨×™×›×” ×œ×¨×¢× ×Ÿ ××ª ×”-token ××•×˜×•××˜×™×ª
4. ×‘×“×•×§ ×‘-Console:
   ```
   [Beds24] Got 401, refreshing token...
   [Beds24] Refreshing user-specific token...
   [Beds24] User-specific token refreshed successfully
   [Beds24] User token saved to database successfully
   ```
5. ×‘×“×•×§ ×©×”-token ×‘××¡×“ ×”× ×ª×•× ×™× ×”×©×ª× ×”:
   ```sql
   SELECT beds24_token, updated_at 
   FROM users 
   WHERE email = 'your-email@example.com';
   ```

---

## ××” ×œ×—×¤×© ×‘×œ×•×’×™×

### ×œ×•×’×™× ××•×¦×œ×—×™× âœ…
```
ğŸ“ Updating booking in Beds24: 12345678
ğŸ“± Normalized mobile: 052-123-4567 -> +972521234567
ğŸ’° Price update via invoice: 750
ğŸ“¦ Update payload: { "id": 12345678, ... }
ğŸ”— POST URL: https://api.beds24.com/v2/bookings
ğŸ”‘ Booking ID (in payload): 12345678
âœ… Beds24 update response: { ... }
âœ… Booking updated successfully: 12345678
```

### ×œ×•×’×™ ×©×’×™××” - Token Expired (×¦×¨×™×š ×œ×”×ª×¨×¢× ×Ÿ ××•×˜×•××˜×™×ª) ğŸ”„
```
[Beds24] Got 401, refreshing token...
[Beds24] Refreshing user-specific token...
[Beds24] User-specific token refreshed successfully
[Beds24] User token saved to database successfully
âœ… Booking updated successfully: 12345678
```

### ×œ×•×’×™ ×©×’×™××” - ×•×œ×™×“×¦×™×” ×©×œ Beds24 âŒ
```
âŒ Beds24 returned validation error: {
  errorMessage: "arrival: Invalid date format",
  errorDetails: [...],
  bookingId: 12345678
}
```

### ×œ×•×’×™ ×©×’×™××” - HTTP Error âŒ
```
âŒ Beds24 API HTTP Error: {
  status: 404,
  statusText: "Not Found",
  details: "...",
  bookingId: 12345678
}
```

---

## ×‘×¢×™×•×ª × ×¤×•×¦×•×ª ×•×¤×ª×¨×•× ×•×ª

### ×‘×¢×™×” 1: "Authentication failed - token may be expired"
**×’×•×¨×:** Token ×¤×’ ×ª×•×§×£ ×•×œ× ×”×¦×œ×™×— ×œ×”×ª×¨×¢× ×Ÿ

**×¤×ª×¨×•×Ÿ:**
1. ×‘×“×•×§ ×©×™×© `beds24_refresh_token` ×ª×§×™×Ÿ ×‘××¡×“ ×”× ×ª×•× ×™×
2. ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×× ×™×© ×©×’×™××ª refresh
3. ×× ×¦×¨×™×š, ×¦×•×¨ token ×—×“×© ×‘-Beds24 control panel

### ×‘×¢×™×” 2: "Booking not found - verify booking ID"
**×’×•×¨×:** ×”-booking ID ×œ× ×§×™×™× ×‘-Beds24

**×¤×ª×¨×•×Ÿ:**
1. ×•×“× ×©×”-booking ID × ×›×•×Ÿ
2. ×‘×“×•×§ ×©-propertyId ×•-roomId × ×›×•× ×™×
3. ×•×“× ×©×”×”×–×× ×” ×œ× × ××—×§×” ×‘-Beds24

### ×‘×¢×™×” 3: "Access denied - check token permissions"
**×’×•×¨×:** ×œ-token ××™×Ÿ ×”×¨×©××•×ª write:bookings

**×¤×ª×¨×•×Ÿ:**
1. ×‘×“×•×§ ××ª ×”-scopes ×©×œ ×”-token ×‘-Beds24
2. ×•×“× ×©×™×© ×”×¨×©××”: `write:bookings`
3. ×× ×¦×¨×™×š, ×¦×•×¨ invite code ×—×“×© ×¢× ×”×”×¨×©××•×ª ×”× ×›×•× ×•×ª

### ×‘×¢×™×” 4: Phone/Price ×œ× ××ª×¢×“×›× ×™×
**×’×•×¨× ××¤×©×¨×™:**
- ×¤×•×¨××˜ ×œ× × ×›×•×Ÿ
- ×©×“×•×ª × ×•×¡×¤×™× ×—×¡×¨×™×
- ×‘×¢×™×” ×‘-Beds24 API

**×¤×ª×¨×•×Ÿ:**
1. ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×”××¤×•×¨×˜×™× ×‘-Console
2. ×‘×“×•×§ ××ª ×”×ª×©×•×‘×” ×-Beds24 (`beds24Response` ×‘×©×’×™××”)
3. ×‘×“×•×§ ×©×”-propertyId ×•-roomId × ×©×œ×—×™×
4. ×× ×¢×“×™×™×Ÿ ×œ× ×¢×•×‘×“, ×‘×“×•×§ ×‘-Beds24 API documentation

---

## ××” ×¢×©×™× ×• ×©×•× ×” ××’×™×©×ª Delete-and-Recreate?

| ×”×™×‘×˜ | ×”×¢×“×›×•×Ÿ ×©×œ× ×• | Delete-and-Recreate |
|------|-------------|---------------------|
| **×”×™×¡×˜×•×¨×™×”** | âœ… × ×©××¨×ª | âŒ × ××—×§×ª |
| **Booking ID** | âœ… × ×©××¨ | âŒ ××©×ª× ×” |
| **API Calls** | 1 | 2 (delete + create) |
| **×¡×™×›×•×Ÿ** | × ××•×š | ×’×‘×•×” (×× delete ×¢×•×‘×¨ ××‘×œ create × ×›×©×œ) |
| **××”×™×¨×•×ª** | ××”×™×¨ | ××™×˜×™ ×™×•×ª×¨ |
| **×¢×•××¡ ×¢×œ Beds24** | × ××•×š | ×›×¤×•×œ |

---

## ×× ×–×” ×¢×“×™×™×Ÿ ×œ× ×¢×•×‘×“...

### ×“×‘×¨×™× × ×•×¡×¤×™× ×œ×‘×“×•×§:

1. **Token Scopes:**
   - ×”×ª×—×‘×¨ ×œ-Beds24 control panel
   - ×œ×š ×œ Settings â†’ API
   - ×‘×“×•×§ ×©×”-token ×©×œ×š ×™×© ×œ×•: `write:bookings` scope

2. **propertyId & roomId:**
   - ×‘×“×•×§ ×©×”× × ×›×•× ×™× ×‘×˜×‘×œ×ª `users`
   - ×•×“× ×©×”× ×§×™×™××™× ×‘-Beds24
   - ×‘×“×•×§ ×©×”××©×ª××© ×©×œ×š ×™×© ×’×™×©×” ××œ×™×”×

3. **Beds24 API Status:**
   - ×‘×“×•×§ ×× Beds24 API ×–××™×Ÿ: https://status.beds24.com
   - ××•×œ×™ ×™×© ×ª×—×–×•×§×” ××• ×‘×¢×™×•×ª ×–×× ×™×•×ª

4. **Network/Firewall:**
   - ×•×“× ×©××™×Ÿ ×—×¡×™××” ×©×œ `api.beds24.com`
   - ×‘×“×•×§ timeout settings

5. **Field Restrictions:**
   - ×™×›×•×œ ×œ×”×™×•×ª ×©-Beds24 ×œ× ×××¤×©×¨ ×œ×¢×¨×•×š ×©×“×•×ª ××¡×•×™××™×
   - ×‘×“×•×§ ×‘-Beds24 documentation ××™×œ×• ×©×“×•×ª × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ

---

## ×¡×™×›×•×

×”×©×™× ×•×™×™× ×©×‘×™×¦×¢× ×• ×××•×¨×™× ×œ×¤×ª×•×¨ ××ª ×”×‘×¢×™×” ×”××§×•×¨×™×ª ×©×œ ×¢×“×›×•×Ÿ ×˜×œ×¤×•×Ÿ ×•××—×™×¨. 

**×”×¡×™×‘×” ×”×¢×™×§×¨×™×ª ×œ×›×™×©×œ×•×Ÿ:** Tokens ×©×œ× × ×©××¨×• ××—×¨×™ refresh, ××” ×©×’×¨× ×œ×›×œ ×‘×§×©×” ×œ×”×™×›×©×œ ×¢× 401 error.

**×”×¤×ª×¨×•×Ÿ:** ×©××™×¨×” ××•×˜×•××˜×™×ª ×©×œ tokens ×—×“×©×™× + ×©×™×¤×•×¨×™× ×‘×•×œ×™×“×¦×™×”, ×œ×•×’×™× ×•×¤×•×¨××˜.

×× ××—×¨×™ ×›×œ ×”×‘×“×™×§×•×ª ×–×” ×¢×“×™×™×Ÿ ×œ× ×¢×•×‘×“, ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×”××¤×•×¨×˜×™× ×•×©×ª×£ ××•×ª× ××™×ª×™ ×›×“×™ ×©××•×›×œ ×œ×¢×–×•×¨ ×™×•×ª×¨!
